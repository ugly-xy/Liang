<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<link href="css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="css/app.css" />
		<link href="css/mui.imageviewer.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="css/style.css"/>
		<style>
			html,
			body {
				height: 100%;
				margin: 0px;
				padding: 0px;
				-webkit-touch-callout: none;
				-webkit-user-select: none;
			}
			footer {
				position: fixed;
				width: 100%;
				height: 50px;
				min-height: 50px;
				border-top: solid 1px #bbb;
				left: 0px;
				bottom: 0px;
				/*overflow: hidden;*/
				padding: 0px 50px;
				background-color: #fafafa;
			}
			header{
				z-index: 999;
				position: relative;	
			}
			.footer-left {
				position: absolute;
				width: 50px;
				height: 50px;
				left: 0px;
				bottom: 0px;
				text-align: center;
				vertical-align: middle;
				line-height: 100%;
				padding: 12px 4px;
			}
			.footer-right {
				position: absolute;
				width: 50px;
				height: 50px;
				right: 0px;
				bottom: 0px;
				text-align: center;
				vertical-align: middle;
				line-height: 100%;
				padding: 12px 5px;
				display: inline-block;
			}
			.footer-center {
				height: 100%;
				padding: 5px 0px;
			}
			.footer-center [class*=input] {
				width: 100%;
				height: 100%;
				border-radius: 5px;
			}
			.footer-center .input-text {
				background: #fff;
				border: solid 1px #ddd;
				padding: 5px !important;
				font-size: 16px !important;
				line-height: 28px !important;
				font-family: verdana !important;
				overflow: hidden;
			}
			.footer-center .input-sound {
				background-color: #eee;
			}
			.mui-content {
				padding: 44px 0px 50px 0px ;
				width: 100%;
				overflow: auto;
				background-color: #eaeaea;
			}
			#msg-list {
				margin-top: 44px;
				overflow: auto;
				-webkit-overflow-scrolling: touch;
			}
			.msg-item {
				padding: 8px;
				clear: both;
			}
			.msg-item .mui-item-clear {
				clear: both;
			}
			.msg-item .msg-user {
				width: 38px;
				height: 38px;
				border: solid 1px #d3d3d3;
				display: inline-block;
				background: #fff;
				border-radius: 3px;
				vertical-align: top;
				text-align: center;
				float: left;
				padding: 3px;
				color: #ddd;
			}
			
			.msg-item .msg-user-img{
				width: 38px;
				height: 38px;
				display: inline-block;
				border-radius: 3px;
				vertical-align: top;
				text-align: center;
				float: left;
				color: #ddd;
			}
			
			.msg-item .msg-content {
				display: inline-block;
				border-radius: 5px;
				border: solid 1px #d3d3d3;
				background-color: #FFFFFF;
				color: #333;
				padding: 8px;
				vertical-align: top;
				font-size: 15px;
				position: relative;
				margin: 0px 8px;
				max-width: 75%;
				min-width: 35px;
				float: left;
			}
			.msg-item .msg-content .msg-content-inner {
				overflow-x: hidden;
			}
			.msg-item .msg-content .msg-content-arrow {
				position: absolute;
				border: solid 1px #d3d3d3;
				border-right: none;
				border-top: none;
				background-color: #FFFFFF;
				width: 10px;
				height: 10px;
				left: -5px;
				top: 12px;
				-webkit-transform: rotateZ(45deg);
				transform: rotateZ(45deg);
			}
			.msg-item-self .msg-user,
			.msg-item-self .msg-content {
				float: right;
			}
			.msg-item-self .msg-content .msg-content-arrow {
				left: auto;
				right: -5px;
				-webkit-transform: rotateZ(225deg);
				transform: rotateZ(225deg);
			}
			.msg-item-self .msg-content,
			.msg-item-self .msg-content .msg-content-arrow {
				background-color: #4CD964;
				color: #fff;
				border-color: #2AC845;
			}
			footer .mui-icon {
				color: #000;
			}
			footer .mui-icon:active {
				color: #007AFF !important;
			}
			footer .mui-icon-paperplane:before {
				content: "발송";
			}
			footer .mui-icon-paperplane {
				/*-webkit-transform: rotateZ(45deg);
				transform: rotateZ(45deg);*/
				
				font-size: 16px;
				word-break: keep-all;
				line-height: 100%;
				padding-top: 6px;
				color: rgba(0, 135, 250, 1);
			}
			#msg-sound {
				-webkit-user-select: none !important;
				user-select: none !important;
			}
			.rprogress {
				position: absolute;
				left: 50%;
				top: 50%;
				width: 140px;
				height: 140px;
				margin-left: -70px;
				margin-top: -70px;
				background-image: url(../images/arecord.png);
				background-repeat: no-repeat;
				background-position: center center;
				background-size: 30px 30px;
				background-color: rgba(0, 0, 0, 0.7);
				border-radius: 5px;
				display: none;
				-webkit-transition: .15s;
			}
			.rschedule {
				background-color: rgba(0, 0, 0, 0);
				border: 5px solid rgba(0, 183, 229, 0.9);
				opacity: .9;
				border-left: 5px solid rgba(0, 0, 0, 0);
				border-right: 5px solid rgba(0, 0, 0, 0);
				border-radius: 50px;
				box-shadow: 0 0 15px #2187e7;
				width: 46px;
				height: 46px;
				position: absolute;
				left: 50%;
				top: 50%;
				margin-left: -23px;
				margin-top: -23px;
				-webkit-animation: spin 1s infinite linear;
				animation: spin 1s infinite linear;
			}
			.r-sigh{
				display: none;
				border-radius: 50px;
				box-shadow: 0 0 15px #2187e7;
				width: 46px;
				height: 46px;
				position: absolute;
				left: 50%;
				top: 50%;
				margin-left: -23px;
				margin-top: -23px;
				text-align: center;
				line-height: 46px;
				font-size: 40px;
				font-weight: bold;
				color: #2187e7;
			}
			.rprogress-sigh{
				background-image: none !important;
			}
			.rprogress-sigh .rschedule{
				display: none !important;
			}
			.rprogress-sigh .r-sigh{
				display: block !important;
			}
			.rsalert {
				font-size: 12px;
				color: #bbb;
				text-align: center;
				position: absolute;
				border-radius: 5px;
				width: 130px;
				margin: 5px 5px;
				padding: 5px;
				left: 0px;
				bottom: 0px;
			}
			@-webkit-keyframes spin {
				0% {
					-webkit-transform: rotate(0deg);
				}
				100% {
					-webkit-transform: rotate(360deg);
				}
			}
			@keyframes spin {
				0% {
					transform: rotate(0deg);
				}
				100% {
					transform: rotate(360deg);
				}
			}
			#h {
				background: #fff;
				border: solid 1px #ddd;
				padding: 10px !important;
				font-size: 16px !important;
				font-family: verdana !important;
				line-height: 18px !important;
				overflow: visible;
				position: absolute;
				left: -1000px;
				right: 0px;
				word-break: break-all;
				word-wrap: break-word;
			}
			.cancel {
				background-color: darkred;
			}
			#msg-text{
				-webkit-user-select:text
			}
			#face a{
				padding: 3.2px; 
				display: inline-block;
				float: left;
			} 
			.emojiSvg{
				width: 25px;
			}
			#face{
				position: absolute;
			    bottom: 50px; 
			    display: none; 
			    background: #fff;
				padding: 0 10px;  
				padding-left: 13px;
			    z-index: 999; 
			}
			.facecon{
				height: 120px;
			    overflow: scroll;
			}
				
			#closebtn3{
				position: absolute;
				left: 0;
				display: inline-block;  
				z-index: 999;
				width: 100%;
				background: #f7f7f7;
				bottom: 120px;
				height: 30px;
				line-height: 30px;
				text-align: center;
				font-size: 15px;
				border-bottom: 1px solid #E3E3E3;
				
			}
			#closebtn3:active{
				background: #f2f2f2;
			}
			.test{
				display: block !important;
			}
			.icon-smail{
				background: url(images/icon-smile.png) no-repeat;
				background-size: 26px;
				width:26px;
				height: 26px;
				
				
			}
			*img{
				vertical-align: bottom;
			}
		</style>
	</head>

	<body contextmenu="return false;">
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">chat (聊天窗口)</h1>
		</header>
		<pre id='h'></pre>
		<script id='msg-template' type="text/template">
			<% for(var i in record){ var item=record[i]; %>
				<div class="msg-item <%= (item.sender=='self'?' msg-item-self':'') %>" msg-type='<%=(item.type)%>' msg-content='<%=(item.content)%>'>
					<% if(item.sender=='self' ) { %>
						<!--<i class="msg-user mui-icon mui-icon-person"></i>-->
						<img class="msg-user-img" src="<%=(item.selfAvatar)%>" alt="" style="float: right;"/>
					<% } else { %>
						<img class="msg-user-img" src="<%=(item.otherAvatar)%>" alt="" />
					<% } %>
					<div class="msg-content">
						<div class="msg-content-inner">
							<% if(item.type=='text' ) { %>
								<%=( item.content|| '&nbsp;&nbsp;') %>
							<% } %>
						</div>
						<div class="msg-content-arrow"></div>
					</div>
					<div class="mui-item-clear"></div>
				</div>
			<% } %>
		</script>
		<header class="mui-bar mui-bar-nav"> 
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
		    <h1 class="mui-title">1:1상담</h1>
		    <a class=" mui-icon  mui-pull-right mui-icon-chatboxes" ></a>
		    
		</header>
		<div class="mui-content">
			
			<div id='msg-list'>
				
			</div>
		</div>

		<div id="face">
			<div class="facecon" id="facecon">
				
			</div>
			<span id="closebtn3">닫기</span>
		</div>
		<footer>

			<div class="footer-left">
				
				<i id='msg-image' class="mui-icon icon-smail" style="font-size: 28px;"></i>
			</div>
			<div class="footer-center">
				<div id='msg-text'  class='input-text' contenteditable="true" ></div>
			</div>
			<label for="" class="footer-right">
				<i id='msg-type' class="mui-icon mui-icon-paperplane"></i>
			</label>
		</footer>
		<div id='sound-alert' class="rprogress">
			<div class="rschedule"></div>
			<div class="r-sigh">!</div>
			<div id="audio_tips" class="rsalert">手指上滑，取消发送</div>
		</div>
		<script src="js/mui.min.js"></script>
		<script src="js/app.js" type="text/javascript"></script>
		<script src="js/mui.imageViewer.js"></script>
		<script src="js/arttmpl.js"></script>
		<script type="text/javascript" charset="utf-8">
			(function($, doc) {
				var MIN_SOUND_TIME = 800;
				$.init({
					gestureConfig: {
						tap: true, //默认为true
						release: true //默认为false，不监听
					}
				});
				template.config('escape', false);
				if(mui.os.ios){
					// 解决在ios上fixed元素focusin时位置出现错误的问题 
					document.addEventListener('DOMContentLoaded',function(){
						var footerDom = document.querySelector('footer');
						
						document.addEventListener('focusin', function() {
							footerDom.style.position = 'absolute';
						});
						document.addEventListener('focusout', function() {
							footerDom.style.position = 'fixed';
						});
					});
				}

				$.plusReady(function() {
					 var face = document.getElementById('facecon');
	                for(var i = 1; i < 50; i++) {
	                    var a = document.createElement("a");
	                    a.href = "javascript:;";
                   
                        a.innerHTML = '<img class="emojiSvg" src="images/emoji/' + i + '.png" alt="" />';
	                    face.appendChild(a);
	                };
	                var pickers = face.getElementsByTagName('a');
	                var emojiInput = document.getElementById('msg-text');
	                for(var i = 0; i < pickers.length; i++) {
	                    	pickers[i].onclick = function(e) {
	            			document.getElementById('msg-text').focus();
						insertHtmlAtCaret(this.innerHTML);
//	                            emojiInput.innerHTML+=this.innerHTML;
	                    }
	                }
					plus.webview.currentWebview().setStyle({
						softinputMode: "adjustResize"
					});
					var showKeyboard = function() {
						if ($.os.ios) {
							var webView = plus.webview.currentWebview().nativeInstanceObject();
							webView.plusCallMethod({
								"setKeyboardDisplayRequiresUserAction": false
							});
						} else {
							var Context = plus.android.importClass("android.content.Context");
							var InputMethodManager = plus.android.importClass("android.view.inputmethod.InputMethodManager");
							var main = plus.android.runtimeMainActivity();
							var imm = main.getSystemService(Context.INPUT_METHOD_SERVICE);
							imm.toggleSoftInput(0, InputMethodManager.SHOW_FORCED);
							//var view = ((ViewGroup)main.findViewById(android.R.id.content)).getChildAt(0);
							imm.showSoftInput(main.getWindow().getDecorView(), InputMethodManager.SHOW_IMPLICIT);
						}
					};
					var record = [{
						sender: 'weshow',
						type: 'text',
						otherAvatar:'./images/logo-login.png',
						content: '..'
					}];
					
					var ui = {
						targetId:"0",
						uid:app.getAccessUserId(),
						body: doc.querySelector('body'),
						footer: doc.querySelector('footer'),
						footerRight: doc.querySelector('.footer-right'),
						footerLeft: doc.querySelector('.footer-left'),
						btnMsgType: doc.querySelector('#msg-type'),
						boxMsgText: doc.querySelector('#msg-text'),
//						btnMsgImage: doc.querySelector('#msg-image'),
						areaMsgList: doc.querySelector('#msg-list'),
						boxSoundAlert: doc.querySelector('#sound-alert'),
						h: doc.querySelector('#h'),
						content: doc.querySelector('.mui-content'),
						imgDomain:"https://img.candy.club",
						ws:""
					};
					ui.h.style.width = ui.boxMsgText.offsetWidth + 'px';
					//alert(ui.boxMsgText.offsetWidth );
					var footerPadding = ui.footer.offsetHeight - ui.boxMsgText.offsetHeight;
					var socketUrl="";
					//socketUrl = "ws://127.0.0.1:7397/websocket"
					var webSocket;
					function initWebSocket() {
						var token =app.getAccessUserId();
						if(!token||null==token||''==token){
							 mui.openWindow({
								id:'noId',
								url:'./login.html'
							});
						}
				        if ("WebSocket" in window) {
				            if (webSocket == null||3==webSocket.readyState) {
				                var url =socketUrl= ui.ws;
				                webSocket = new WebSocket(url);
				            } else {
				                alert("您已进入聊天室...");
				            }
				  	
				            webSocket.onopen = function () {
					            	var body ={"token":token};
					            	toSend(1,"login",body);
				            };
			 			   	
				            webSocket.onmessage = function (evt) {
				                var received_msg = evt.data;
				                console.log(received_msg);
				                var jm = JSON.parse(received_msg);
				                if(ui.targetId==jm.data.frid)return;
				                if(jm.method=="chatP2P"){
				                 	    var	aa=jm.data.frid;
						                var 	bb=ui.imgDomain+substrAvatar(jm.data.avatar);
						                	var cc=jm.data.nickname;
						                	var dd=jm.data.txt;
					                     record.push({
											sender: cc,
											type: 'text',
											otherAvatar:bb,
											content: dd
										});
				               	 	
				                }else if(jm.method=="back"){
				                 	var info ="fault link ..";
				                 	if(jm.data.reMe&&jm.data.reMe!=null){
				                 		info =jm.data.reMe;
				                 	}else{
				                 		info =jm.data.error;
				                 	}
				                 	if(jm.data.status&&jm.data.status=="ok"){
				                 		info ="welcome.."+info;
				                 	}else{
				                 		info ="Failed.."+info;
				                 	}
				                 	record[0].sender=jm.data.reid;
				                 	record[0].content=info;
				                }
				                
				                bindMsgList();
				            };
				            webSocket.onclose = function () {
				                record.splice(1,record.length)
				                if(webSocket&&webSocket!=null){
				                	 	webSocket.close();
				               		 webSocket = null;
				                }
				            };
				        }
				        else {
				            // 浏览器不支持 WebSocket
				            alert("您的浏览器不支持 WebSocket!");
				        }
		       		 }
					
					var old_back = mui.back;  
					mui.back = function(){  
						if(webSocket&&webSocket!=null){
		                	 	webSocket.close();
		               		webSocket = null;
		                }
					    old_back();  
					} 
					
					function substrAvatar(str){
						var selfDir= "./images/";
						var unobj="/active/image/avatar/";
						if(str.indexOf(unobj)>0){
							return selfDir+str.substr(str.indexOf(unobj)+n.length)
						}
						return str;
					}
					
					validUid();
					function validUid(){
						mui.getJSON(app.serverApi(app.apiConstant.queryUid),{},function(res){
							app.respondingTo(res.code,function(code){
								if(0!=code){
									plus.nativeUI.toast(res.msg);
								}else{
									ui.targetId=res.data.uid+"";
									ui.imgDomain=res.data.imgDomain+"";
									ui.ws=res.data.ws+"";
									initWebSocket();
								}
							})
						})
					}
					
					function toSend(id,method,data){
				    	 	if (webSocket != null) {
				             var msg = {"id":id,"method":method,"data":data};
				         	 webSocket.send(JSON.stringify(msg));
				         } else {
				        	 initWebSocket();
				         //alert("您已掉线，请重新进入聊天室...");
				         }
				    }
					
					var bindMsgList = function() {
						//绑定数据:
						/*tp.bind({
							template: 'msg-template',
							element: 'msg-list',
							model: record
						});*/
						ui.areaMsgList.innerHTML = template('msg-template', {
							"record": record
						});
						
						ui.areaMsgList.scrollTop = ui.areaMsgList.scrollHeight + ui.areaMsgList.offsetHeight;
					};
					
					window.addEventListener('resize', function() {
						ui.areaMsgList.scrollTop = ui.areaMsgList.scrollHeight + ui.areaMsgList.offsetHeight;
					}, false);
					var send = function(msg) {
						record.push(msg);
						bindMsgList();
						var data  = {"txt":msg.content}
						toSend(12,"chatP2P",data);
					};
					var toRobot = function(info) {
//						var apiUrl = 'http://www.tuling123.com/openapi/api';
//						$.getJSON(apiUrl, {
//							"key": 'acfbca724ea1b5db96d2eef88ce677dc',
//							"info": info,
//							"userid": plus.device.uuid
//						}, function(data) {
//							alert(JSON.stringify(data));
//							record.push({
//								sender: 'zs',
//								type: 'text',
//								content: data.text
//							});
//							bindMsgList();
//						});
					};
					document.getElementById('closebtn3').addEventListener('tap',function(){
						$.trigger(ui.footerLeft,'tap');
						
					})
					
					function msgTextFocus() {
							ui.boxMsgText.focus();
							setTimeout(function() {
								ui.boxMsgText.focus();
								ui.boxMsgText.innerHTML = ''
//								document.getElementById('face').style.display="none";

							}, 150);
							
						}
						//解决长按“发送”按钮，导致键盘关闭的问题；
					ui.footerRight.addEventListener('touchstart', function(event) {
						if (ui.btnMsgType.classList.contains('mui-icon-paperplane')) {
							msgTextFocus();
							event.preventDefault();
						}
					});
					//解决长按“发送”按钮，导致键盘关闭的问题；
					ui.footerRight.addEventListener('touchmove', function(event) {
						if (ui.btnMsgType.classList.contains('mui-icon-paperplane')) {
							msgTextFocus();
							event.preventDefault();
						}
					});
					ui.footerRight.addEventListener('touchcancel', function(event) {
						if (ui.btnMsgType.classList.contains('mui-icon-paperplane')) {
							msgTextFocus();
							event.preventDefault();
						}
					});
					ui.footerRight.addEventListener('touchend', function(event) {
						if (ui.btnMsgType.classList.contains('mui-icon-paperplane')) {
							msgTextFocus();
							event.preventDefault();
						}
					});
					
					ui.footerRight.addEventListener('release', function(event) {
						if (ui.btnMsgType.classList.contains('mui-icon-paperplane')) {
							//showKeyboard();
							if(ui.boxMsgText.innerHTML==''){
								mui.toast('不能发送空消息');
								return false;
							}
							ui.boxMsgText.focus();
							setTimeout(function() {
								ui.boxMsgText.focus();
								var eid =document.getElementById('face');
								removeClass(eid,'test');
								
							}, 150);
							//event.detail.gesture.preventDefault();
							
							send({
								sender: 'self',
								type: 'text',
								selfAvatar:app.getSelfAvatar(),
								content: ui.boxMsgText.innerHTML
							});
							ui.boxMsgText.value = '';
							$.trigger(ui.boxMsgText, 'input', null);
						} 
					}, false);
					ui.footerLeft.addEventListener('tap', function(event) {
						toggleClassTest();
					}, false); 
					var setSoundAlertVisable=function(show){
						if(show){
							ui.boxSoundAlert.style.display = 'block';
							ui.boxSoundAlert.style.opacity = 1;
						}else{
							ui.boxSoundAlert.style.opacity = 0;
							//fadeOut 完成再真正隐藏
							setTimeout(function(){ 
								ui.boxSoundAlert.style.display = 'none';
							},200);
						}
					};
				
					ui.boxMsgText.addEventListener('div', function(event) {
						
						ui.h.innerText = ui.boxMsgText.innerHTML.replace(new RegExp('\n', 'gm'), '\n-') || '-';
						ui.footer.style.height = (ui.h.offsetHeight + footerPadding) + 'px';
						ui.content.style.paddingBottom = ui.footer.style.height;
					});
					var focus = false;
					ui.boxMsgText.addEventListener('tap', function(event) {
						ui.boxMsgText.focus();
						setTimeout(function() {
							ui.boxMsgText.focus();
						}, 0);
						focus = true;
						setTimeout(function () {
							focus = false;
						},1000);
						event.detail.gesture.preventDefault();
					}, false);
					//点击消息列表，关闭键盘
					ui.areaMsgList.addEventListener('tap',function (event) {
						if(!focus){
							ui.boxMsgText.blur();
						}
					})
					
				});
				
			}(mui, document));
			function hasClass(obj, cls) {  
			    return obj.className.match(new RegExp('(\\s|^)' + cls + '(\\s|$)'));  
			}  
			  
			function addClass(obj, cls) {  
			    if (!this.hasClass(obj, cls)) obj.className += " " + cls;  
			}  
			  
			function removeClass(obj, cls) {  
			    if (hasClass(obj, cls)) {  
			        var reg = new RegExp('(\\s|^)' + cls + '(\\s|$)');  
			        obj.className = obj.className.replace(reg, ' ');  
			    }  
			}  
			function toggleClass(obj,cls){  
			    if(hasClass(obj,cls)){  
			        removeClass(obj, cls);  
			    }else{  
			        addClass(obj, cls);  
			    }  
			}  
			function toggleClassTest(){  
			    var obj = document.getElementById('face');  
			    toggleClass(obj,"test");
			} 
			function insertHtmlAtCaret(html) {
		        var sel, range;
		        if (window.getSelection) {
		            // IE9 and non-IE
		            sel = window.getSelection();
		            if (sel.getRangeAt && sel.rangeCount) {
		                range = sel.getRangeAt(0);
		                range.deleteContents();
		                // Range.createContextualFragment() would be useful here but is
		                // non-standard and not supported in all browsers (IE9, for one)
		                var el = document.createElement("div");
		                el.innerHTML = html;
		                var frag = document.createDocumentFragment(), node, lastNode;
		                while ((node = el.firstChild)) {
		                    lastNode = frag.appendChild(node);
		                }
		                range.insertNode(frag);
		                // Preserve the selection
		                if (lastNode) {
		                    range = range.cloneRange();
		                    range.setStartAfter(lastNode);
		                    range.collapse(true);
		                    sel.removeAllRanges();
		                    sel.addRange(range);
		                }
		            }
		        } else if (document.selection && document.selection.type != "Control") {
		            // IE < 9
		            document.selection.createRange().pasteHTML(html);
		        }
		    }

		</script>
	</body>

</html>