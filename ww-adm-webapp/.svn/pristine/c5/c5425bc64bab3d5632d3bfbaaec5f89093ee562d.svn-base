<#import "/spring.ftl" as spring /> 
<#import "/admin/layouts/common.xhtml" as layout>
<@layout.title>用户</@layout.title> <@layout.metaKeywordsDescription>

</@layout.metaKeywordsDescription> 
<@layout.cssLink> 
<link rel="stylesheet" type="text/css" href="/webuploader/webuploader.css">
</@layout.cssLink>
<@layout.pageHeader> 用户详情 </@layout.pageHeader> 
<@layout.mainContent>
<input type="hidden" id="nav_id" value="user" />
<div class="row">
	<div class="col-lg-8">
		<form role="form" id="form">
		<div class="form-group col-lg-9">
			<div class="form-group form-inline">
				<label>用户名：</label>  ${(obj.username)!} （${(obj._id)!}）
			</div>
			<div class="form-group form-inline">
				<label>头像：</label>
				<img id="pic" src="<#if (obj.avatar)?? ><@layout.img path=obj.avatar></@layout.img></#if>" width="120px"  /> 
				<BUTTON id="reAvatar">随机换头像</BUTTON> 
				<!--<label>封面：</label>
				<img id="imgCover" src="<#if (obj.cover)?? ><@layout.img path=obj.cover></@layout.img></#if>" width="120px"  /> 
				<BUTTON id="filePicker">更换封面</BUTTON><BUTTON id=delCover>删除封面</BUTTON>-->
			</div>
			
			<div class="form-group form-inline">
				<label>签名(Label):</label>  
				<TEXTAREA id="personLabel" name="personLabel" cols="20" rows="1" >${(obj.personLabel)!}</TEXTAREA>
				<BUTTON id="reLabel">修改签名</BUTTON>
			</div>
			
			<div class="form-group form-inline">
			<label>修改签名权限：</label>  
			    <input type="radio" id="modifyLabel" name="modifyLabel"  value="true" <#if obj.modifyLabel?? && obj.modifyLabel>checked="true" </#if> />允许 
			    <input type="radio" id="modifyLabel" name="modifyLabel"  value="false" <#if !obj.modifyLabel?? || !obj.modifyLabel>checked="true" </#if> />不允许
			    <BUTTON id="setModifyLabel">修改权限</BUTTON>
			</div>
			 
			<div class="form-group form-inline">
				<label>标签(Tags)：</label>  
				<TEXTAREA id="tags" name="tags" cols="20" rows="1" placeholder="key=value;key=value;">${(obj.tags)!}</TEXTAREA>
				<BUTTON id="reTags">修改标签</BUTTON>
			</div>
			
			<div class="form-group">
				<input type="hidden" id="uid" name="uid" value="${(obj._id)!}" />
				<label>昵称：</label>
				<input type="text" id="nickname" name="nickname" value="${(obj.nickname)!}" /> <BUTTON id="submit">修改昵称</BUTTON><br/>
				<label>密码：</label>
				<input type="text" id="newPwd" name="newPwd" value="" /> <BUTTON id="rePwd">修改密码</BUTTON><br/>
			</div>
			
			<div class="form-group form-inline">
				<label>Email：</label>  ${(obj.email)!} （${(obj.emailVeri)!}）
			</div>
			<div class="form-group form-inline">
				<label>手机：</label>  <input id="phone" name="phone" value="${(obj.phone)!}" /> （${(obj.phoneVeri)!}）
			</div>
			<div class="form-group form-inline">
				<label>省市：</label> 
				<input id="province" name="province" placeholder="示例:北京" style="width:100px;" value="${(obj.province)!}" /> 
				<input id="city" name="city"  placeholder="示例:朝阳" style="width:100px;" value="${(obj.city)!}" /> 
				<button id="setAddress">更新省市</button>
			</div>
			
			<div class="form-group form-inline">
				<label>渠道：</label>  ${(obj.ch)!}-${(obj.childCh)!}
			</div>
			
			<div class="form-group form-inline">
				<label>注册类型：</label> <#if obj.thirdType??><#if obj.thirdType==2>QQ<#elseif obj.thirdType==3>微信<#elseif obj.thirdType==4>微博<#else>普通</#if></#if>
			</div>
			
			<div class="form-group form-inline">
				<label>积分：</label>  ${(obj.point)!}
			</div>
			
			<div class="form-group form-inline">
				<label>状态：</label>  <input type="radio" id="status" name="status"  value="1" <#if (obj.status)??&&obj.status==1 >checked="true"</#if> />正常
				<input type="radio" id="status" name="status"  value="-1" <#if (obj.status)??&&obj.status==-1 >checked="true"</#if> />锁定
			</div>
			
			<div class="form-group form-inline">
				<label>注册IP：</label>  ${(obj.regIp)!}
			</div>
			<div class="form-group form-inline">
				<label>金币：</label> <b> ${(obj.coin)!}</b>
			</div>
			<div class="form-group form-inline">
				<label>VIP：</label>
			${(obj.vip)!'0'}&nbsp;->&nbsp; VIP：
							<#if obj.vip??>
								<#if obj.vip lt 600>0<#elseif obj.vip lt 3000>1<#elseif obj.vip lt 10000>2<#elseif obj.vip lt 50000>3
							<#elseif obj.vip lt 200000>4<#elseif obj.vip lt 600000>5<#elseif obj.vip lt 1500000>6<#elseif obj.vip lt 3000000>7
							<#elseif obj.vip lt 6000000>8<#elseif obj.vip lt 10000000>9<#else>10</#if>
							</#if>
				<input type="text" id="vipVal" name="vipVal" value="" size="10"/> <BUTTON id="vipChange">修改VIP</BUTTON>			
			</div>
			<div class="form-group form-inline">
				<label>性别：</label>  <input type="radio" id="sex" name="sex"  value="1" <#if (obj.sex)??&&obj.sex==1 >checked="true"</#if> />男 
				<input type="radio" id="sex" name="sex"  value="2" <#if (obj.sex)??&&obj.sex==2 >checked="true"</#if> />女
			</div>
			
			<div class="form-group form-inline">
				<label>角色</label>  <#if obj.role?? && obj.role==2>管理
					<#elseif obj.role?? && obj.role==3>机器人
					<#elseif obj.role?? && obj.role==4>评论机器人
							<#else>普通</#if>
					<input type="radio" id="role" name="role"  value="1" <#if (obj.role)??&&obj.role==1 >checked="true"</#if> />普通用户
					<input type="radio" id="role" name="role"  value="2" <#if (obj.role)??&&obj.role==2 >checked="true"</#if> />管理 
					<input type="radio" id="role" name="role"  value="3" <#if (obj.role)??&&obj.role==3 >checked="true"</#if> />机器人
					<input type="radio" id="role" name="role"  value="4"  <#if (obj.role)??&&obj.role==4 >checked="true"</#if> />评论机器人
			</div>
			
			<div class="form-group form-inline">
				<label>创建时间：</label>${obj.createTime?number?number_to_datetime} 
			</div>
			
			<div class="form-group form-inline">
				<label>更新时间：</label> ${obj.updateTime?number?number_to_datetime} 
			</div>
			<BUTTON id="submitAll">提交</BUTTON>
			</div>
			<div class="col-lg-1"></div>
			<div class="col-lg-2">
			<div class="rows">
				<div class="form-group">
				<label>个人相册</label>
				<div id="fileList" class="uploader-list">
					<#if (obj.photos)?? > <#list obj.photos as photo>
						<div id="o_${photo_index}" class="file-item thumbnail upload-state-done">
							<a href="<@layout.img path=photo suffix="@!bi7"></@layout.img>" target="_break"><img src="<@layout.img path=photo suffix="@!bi7"></@layout.img>" width="200px" /></a>
							<a href="#" class="btn btn-sm btn-default picdel" data-id="o_${photo_index}">删除</a>
							<input type="hidden" name="photo" value="<@layout.img path=photo></@layout.img>" /> 
						</div>
					</#list>
					</#if>
				</div>
				<div id="filePicker2">选择图片</div>
			</div>
			</div>
			</div>
		</form>
	</div>

</div>
<!-- /.row (nested) -->

</@layout.mainContent>
 <@layout.script> 
<script type="text/javascript" src="/webuploader/webuploader.js"></script>
<script>
$(function() {
	$("#submitAll").click(function(e) {
		e.preventDefault();
		var t = this;
		var photos = "";
		$('input[name="photo"]').each(function() {
			photos = photos + $(this).val() + ",";
		});
		if (photos.length > 0) {
			photos = photos.substring(0, photos.length - 1);
		}
		//var typeValue = $("input[name*='type']:checked").val()
		var jsonData = {
				"uid" : $("#uid").val(),
				"phone" : $("#phone").val(),
				"status":$("input[name*='status']:checked").val(),
				"sex":$("input[name*='sex']:checked").val(),
				"role":$("input[name*='role']:checked").val(),
				"photos":photos,
				"personLabel":$("#personLabel").val()
			};
		$.post("/admin/user/info", jsonData, function(ret) {
			if (0 != ret.code) {
				alert(ret.Msg);
			} else {
				 location.reload() ;
				alert("Success");
				
			}
		});
	});
	
	$("#vipChange").click(function(e) {
		e.preventDefault();
		var t = this;
		var jsonData = {
				"uid" : $("#uid").val(),
				"vipVal" : $("#vipVal").val()
			};
		$.post("/admin/user/vip", jsonData, function(ret) {
			if (0 != ret.code) {
				alert(ret.Msg);
			} else {
				location.reload() ;
				alert("Success");
			}
		});
	});
	
	    $(".picdel").click(function() {
		    var id = $(this).data("id");
		    $('#' + id).remove();
	    });
	    
		$("#submit").click(function(e) {
			e.preventDefault();
			var t = this;
			var jsonData = {
					"uid" : $("#uid").val(),
					"nickname" : $("#nickname").val()
				};
			$.post("/admin/user/nickname", jsonData, function(ret) {
				if (0 != ret.code) {
					alert(ret.Msg);
				} else {
					alert("Success");
				}
			});
		});
		$("#rePwd").click(function(e) {
			e.preventDefault();
			var t = this;
			var jsonData = {
					"uid" : $("#uid").val(),
					"newPwd" : $("#newPwd").val()
				};
			$.post("/admin/user/pwd", jsonData, function(ret) {
				if (0 != ret.code) {
					alert(ret.Msg);
				} else {
					alert("Success");
				}
			});
		});
		
		$("#setAddress").click(function(e) {
			e.preventDefault();
			var t = this;
			var jsonData = {
					"uid" : $("#uid").val(),
					"province" : $("#province").val(),
					"city" : $("#city").val()
				};
			$.post("/admin/user/setAddress", jsonData, function(ret) {
				if (0 != ret.code) {
					alert(ret.Msg);
				} else {
					alert("Success");
				}
			});
		});
		
		$("#reLabel").click(function(e) {
			e.preventDefault();
			var t = this;
			var jsonData = {
					"uid" : $("#uid").val(),
					"personLabel" : $("#personLabel").val()
				};
			$.post("/admin/user/personLabel", jsonData, function(ret) {
				if (0 != ret.code) {
					alert(ret.Msg);
				} else {
					alert("Success");
				}
			});
		});
		
		$("#setModifyLabel").click(function(e) {
			e.preventDefault();
			var t = this;
			var jsonData = {
					"uid" : $("#uid").val(),
					"modifyLabel":$("input[name*='modifyLabel']:checked").val()
				};
			$.post("/admin/user/setModifyLabel", jsonData, function(ret) {
				if (0 != ret.code) {
					alert(ret.Msg);
				} else {
					alert("Success");
				}
			});
		});
		
		$("#reTags").click(function(e) {
			e.preventDefault();
			var t = this;
			var jsonData = {
					"uid" : $("#uid").val(),
					"tags" : $("#tags").val()
				};
			$.post("/admin/user/setTags", jsonData, function(ret) {
				if (0 != ret.code) {
					alert(ret.Msg);
				} else {
					alert("Success");
				}
			});
		});
		
		$("#delCover").click(function(e) {
			e.preventDefault();
			var t = this;
			var jsonData = {
					"uid" : $("#uid").val(),
				};
			$.post("/admin/user/cover", jsonData, function(ret) {
				if (0 != ret.code) {
					alert(ret.Msg);
				} else {
					$("#imgCover").attr('src', "");
					alert("Success");
				}
			});
		});
		
		$("#reAvatar").click(function(e) {
			e.preventDefault();
			var t = this;
			var jsonData = {
					"uid" : $("#uid").val()
				};
			$.post("/admin/user/avatar", jsonData, function(ret) {
				if (0 != ret.code) {
					alert(ret.Msg);
				} else {
					document.location.reload(); 
				}
			});
		});

		$("#reset").click(function(e) {

		});
	});
	
	var $accToken = $.cookie('accessToken');

	uploader = WebUploader.create({
		auto : true,
		swf : '/webuploader/Uploader.swf',
		// 文件接收服务端。
		server : '<@layout.api path="/sys/admPic" />',
		// 选择文件的按钮。可选。
		// 内部根据当前运行是创建，可能是input元素，也可能是flash.
		pick : '#filePicker',

		// 只允许选择图片文件。
		accept : {
			title : 'Images',
			extensions : 'gif,jpg,jpeg,bmp,png',
			mimeTypes : 'image/*'
		},
		formData : {
			"token" : '<@layout.token />'
		}
	});
	
	uploader.on('fileQueued', function(file) {

	});

	uploader.on('uploadProgress', function(file, percentage) {
		var $li = $('#' + file.id), $percent = $li.find('.progress span');

		// 避免重复创建
		if (!$percent.length) {
			$percent = $('<p class="progress"><span></span></p>').appendTo(
					$li).find('span');
		}

		$percent.css('width', percentage * 100 + '%');
	});

	// 文件上传成功，给item添加成功class, 用样式标记上传成功。
	uploader.on('uploadSuccess', function(file, res) {
		$('#' + file.id).addClass('upload-state-done');
		if (res.code == 0) {
			$("#imgCover").attr('src', res.data);
			var jsonData = {
					"uid" : $("#uid").val(),
					"cover":res.data
				};
			$.post("/admin/user/cover", jsonData, function(ret) {
				if (0 != ret.code) {
					alert(ret.Msg);
				} else {
					alert("Success");
				}
			})
		}
	});

	// 文件上传失败，显示上传出错。
	uploader.on('uploadError', function(file) {
		var $li = $('#' + file.id), $error = $li.find('div.error');

		// 避免重复创建
		if (!$error.length) {
			$error = $('<div class="error"></div>').appendTo($li);
		}

		$error.text('上传失败');
	});

	// 完成上传完了，成功或者失败，先删除进度条。
	uploader.on('uploadComplete', function(file) {
		$('#' + file.id).find('.progress').remove();
	});
	    
	$list = $('#fileList'),

	uploader2 = WebUploader.create({
		auto : true,
		swf : '/webuploader/Uploader.swf',
		server : '<@layout.api path="/sys/admPicZim" />',
		pick : '#filePicker2',
		multiple : true,
		accept : {
			title : 'Images',
			extensions : 'gif,jpg,jpeg,bmp,png',
			mimeTypes : 'image/*'
		},
		formData : {
			"token" : '<@layout.token />'
		}
	});

	uploader2.on('fileQueued', function(file) {
		var $li = $('<div id="' + file.id + '" class="file-item thumbnail">'
				+ '<img>' + '</div>'), $img = $li.find('img');

		// $list为容器jQuery实例
		$list.append($li);

		// 创建缩略图
		thumbnailWidth = 100;
		thumbnailHeight = 100;
		uploader.makeThumb(file, function(error, src) {
			if (error) {
				$img.replaceWith('<span>不能预览</span>');
				return;
			}
			$img.attr('src', src);
		}, thumbnailWidth, thumbnailHeight);
	});

	uploader2.on('uploadProgress', function(file, percentage) {
		var $li = $('#' + file.id), $percent = $li.find('.progress span');
		// 避免重复创建
		if (!$percent.length) {
			$percent = $('<p class="progress"><span></span></p>').appendTo($li)
					.find('span');
		}
		$percent.css('width', percentage * 100 + '%');
	});

	// 文件上传成功，给item添加成功class, 用样式标记上传成功。
	uploader2.on('uploadSuccess',function(file, res) {
						//alert(res.code+" "+res.data);
						$('#' + file.id).addClass('upload-state-done');
						var $span = $('<input type="hidden" name="photo" value="'+res.data+'" />');
						$('#' + file.id).append($span);
					});

	// 文件上传失败，显示上传出错。
	uploader2.on('uploadError', function(file) {
		var $li = $('#' + file.id), $error = $li.find('div.error');
		// 避免重复创建
		if (!$error.length) {
			$error = $('<div class="error"></div>').appendTo($li);
		}
		$error.text('上传失败');
	});

	// 完成上传完了，成功或者失败，先删除进度条。
	uploader2.on('uploadComplete', function(file) {
		$('#' + file.id).find('.progress').remove();
	}); 
</script>
</@layout.script>
