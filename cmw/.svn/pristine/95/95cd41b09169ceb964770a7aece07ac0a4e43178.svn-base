<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<link rel="stylesheet" type="text/css" href="/active/assets/css/jquery.emoji.css"/>
		<link rel="stylesheet" type="text/css" href="/active/assets/css/jquery.mCustomScrollbar.min.css"/>
		<link rel="stylesheet" type="text/css" href="/active/css/globel.css"/>
		
		<style type="text/css">
			body,html{
				width: 746px;
				height: 622px;
				min-width: auto;
			}
			.messagecon{ width: 746px; margin:10px; height: 622px; background: #fff; border-radius: 3px;box-shadow: 0px 0px 11px #e0e0e0; border: 1px solid #D5D5D5; font-weight: 400;}
			.mssage-head{
				height: 65px;
				overflow: hidden;
				background: #F5F5F5;
				border-bottom: 1px solid #D5D5D5;	
			}
			.mssage-head ul li{
				float: left;
				margin-left: 40px;
			}
			.mssage-head ul li a{
				display: inline-block;
				font-size: 18px;
				line-height: 25px;
				padding: 20px 0;
				font-weight: 400;
			}
			.mssage-head ul li.active a{
				color: #FF4984;
			}
			.container{
				height: 424px;
				border-bottom: 1px solid #d5d5d5;
				overflow: scroll;
				font-size: 16px;
				background: #fff;
			}
			.container .view{
				display: none;
				padding: 23px;
			}
			.container .view dl{
				overflow: hidden;
				margin-top: 18px;
			}
			.container .view dl dt{
				width: 44px;
				height: 44px;
				overflow: hidden;
				float: left;
				border-radius: 22px;
				background: #FF428C;
				text-align: center;
				
			}
			.container .view dl dd{
				max-width: 520px;
				float: left;
				margin-left: 10px;
			}
			.container .view.active{
				display: block;
			}
			.container .view dl dd .datail{
				width: auto;
				margin-top: 10px;
				background: #F5F5F5;
				border-radius: 4px;
				padding: 10px;
			}
			.container .view dl.mymessage dt{
				float: right;
				
			}
			.container .view dl.mymessage dd{
				float: right;
				margin: 0;
				margin-right: 10px;
			}
			.container .view dl.mymessage dd .names{
				text-align: right;
			}
			.container .view dl.mymessage dd .datail{
				background: #B8E986;
			}
			.container .view dl.official-service dd .datail{
				background: #FFE4E4;
				color: #D0021B;
			}
			.container .view dl.official-service dd .names{
				color: #D0021B;
			}
			.message-edit{
				padding: 0 23px;
				padding-bottom: 23px;
				position: relative;
			}
			.sendmessage{
				position: absolute;
				right: 23px;
				bottom: 30px;
				padding: 0 20px;
				height: 30px;
				background: #FF4984;
				color: #FFFFFF;
				font-size: 16px;
				border: 0;
				border-radius: 4px;
				box-shadow: 0 0 5px #ccc;
				outline: none;
				cursor: pointer;
			}
			.edithead{
				padding: 10px 0;
			}
			.edithead a{ display: inline-block; margin-right: 15px;}
			.editdatail textarea{
				width:616px;
				outline: none;
				resize: none;
				height: 74px;
				overflow: hidden;
				overflow-y: auto;
				border: none;
				font-size: 16px;
			}
			
			.emoji_content{
				background: #fff;
			}
			.emoji_container{
				bottom: 130px;
				top: auto !important;
				left: 10px !important;
			}
		</style>
	</head>
	<body style="background: none;">
		<div class="messagecon">
			<div class="mssage-head">
				<ul>
					<li class="active"><a href="javascript:;">채팅방</a></li>
					<li><a href="javascript:;">1:1상담</a></li>
				</ul>
			</div>
			<div class="container">
				<div id="allText" class="view active">
					
				</div>
				<div id="p2pText" class="view">
					
				</div>
			</div>
			<div class="message-edit">
				<div class="edithead">
					<a href="javascript:;"><img src="/active/assets/image/message-ico1.png" width="18"  id="bqbtn"/></a>
					<a href=""><img src="/active/assets/image/message-ico2.png" width="18"/></a>
					<div class="expression-ico">
						
					</div>
				</div>
				<div class="editdatail">
					<textarea id="input_msg" name="input_msg" rows="" cols=""></textarea>
					<input type="button" name="" id="sendmessage" class="sendmessage" onclick="chatAll()" value="발송" />
				</div>
			</div>
		</div>
		<script src="/active/assets/js/jquery-1.12.3.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="/active/assets/js/jquery.mCustomScrollbar.min.js" type="text/javascript" charset="utf-8"></script>
		
		<script src="/active/assets/js/jquery.emoji.min.js" type="text/javascript" charset="utf-8"></script>
	    	<script type="text/javascript">
	    		$(document).keyup(function(event){
			  if(event.keyCode ==13){
			   chatAll();
			  }
			});
			
			$("#input_msg").emoji({
			    animation: 'fade',
			    button:"#bqbtn",
			    showTab:false,
			    icons: [{
			        name: "emoji",
			        path: "/active/assets/image/tieba/",
			        maxNum: 50,
			        file: ".jpg"
			    }]
			});
				$('.mssage-head ul li').click(function() {
					var ddd = $(this).index();
					$('.mssage-head ul li').removeClass('active')
					$(this).addClass("active")
					$(".container .view").removeClass('active')
					$(".container .view").eq(ddd).addClass('active')
				});
				
				/* window.onload = function(){
					initWebSocket() 
				}; */

				var webSocket;
			    var isLogin = false;
			    var uid = ${uid!'0'};
			    var domain = "${imgDomain!}";
			    function getCookie(c_name){
			    if (document.cookie.length>0)
			      {
			      c_start=document.cookie.indexOf(c_name + "=")
			      if (c_start!=-1)
			        { 
			        c_start=c_start + c_name.length+1 
			        c_end=document.cookie.indexOf(";",c_start)
			        if (c_end==-1) c_end=document.cookie.length
			        return unescape(document.cookie.substring(c_start,c_end))
			        } 
			      }
			    return ""
			    }
			 
			    function chatAll() {
		            var input_msg = document.getElementById("input_msg").value.trim();
		            if (input_msg == "") {
		                return;
		            }
		            var data  = {"txt":input_msg}
		            send(12,"chatAll",data);
		            // 清除input框里的信息
		            document.getElementById("input_msg").value = "";
			    };
			    
			    function send(id,method,data){
			    	 if (webSocket != null) {
			             var msg = {"id":id,"method":method,"data":data};
			         	 webSocket.send(JSON.stringify(msg));
			         } else {
			        	 initWebSocket();
			        	 //send(id,method,data)
			         //alert("您已掉线，请重新进入聊天室...");
			         }
			    }
			 
			    function closeWs() {
			        webSocket.close();
			    };
			 
			    function initWebSocket() {
			    	var token = getCookie("accessToken");
			    	if(token==null || token==""){
			    		//alert("not login");
			    		return ;
			    	}
		        if ("WebSocket" in window) {
					//alert("您的浏览器支持 WebSocket!");
		            if (webSocket == null) {
		                var url = "${ws!}";
		                // 打开一个 web socket
		                webSocket = new WebSocket(url);
		            } else {
		                alert("您已进入聊天室...");
		            }
		 
		            webSocket.onopen = function () {
			            	var body ={"token":token};
			            	send(1,"login",body);
		                //alert("已进入聊天室，畅聊吧...");
		            };
	 			 
		            webSocket.onmessage = function (evt) {
		                var received_msg = evt.data;
		                	var msgheight = document.getElementById("allText").clientHeight + document.getElementById("p2pText").clientHeight;
		                	var msgbody = document.getElementById("container");
		                	console.log(msgheight)
		                console.log(received_msg);
		                var jm = JSON.parse(received_msg);
		                if(jm.method=="chatAll"){
			                	var msg_board = document.getElementById("allText");
			               	var old_msg = msg_board.innerHTML;
			                     msg_board.innerHTML = old_msg + 
			                     '<dl '+(uid==jm.data.frid?'class="mymessage"':'')+'><dt><img src="'+domain+jm.data.avatar+'" width="44" height="44"/></dt><dd><div class="names">'+jm.data.nickname+'</div><div class="datail">'+jm.data.txt+'</div></dd></dl>';
			                     // 让滚动块往下移动
			                     msgbody.scrollTop = msgheight;
		                }else if(jm.method=="chatP2P"){
		               	 	var msg_board = document.getElementById("p2pText");
		                	 	var old_msg = msg_board.innerHTML;
			                    msg_board.innerHTML = old_msg + '<dl '+(uid==jm.data.frid?'class="mymessage"':'')+'><dt><img src="'+domain+jm.data.avatar+'" width="44" height="44"/></dt><dd><div class="names">'+jm.data.nickname+'</div><div class="datail">'+jm.data.txt+'</div></dd></dl>';
			                     // 让滚动块往下移动
			                     msgbody.scrollTop = msgheight;
			                }else if(jm.method=="back"){
				                	if(jm.data.reMe=="login" && jm.data.status=="ok"){
				                		isLogin = true;
				                	}
		                }
		               
		            };
		            webSocket.onclose = function () {
		                // 关闭 websocket，清空信息板
		                //alert("连接已关闭...");
		                webSocket = null;
		                //document.getElementsByClassName("msg_board")[0].innerHTML = "";
		            };
		        }
		        else {
		            // 浏览器不支持 WebSocket
		            alert("您的浏览器不支持 WebSocket!");
		        }
		    }
			    
		</script>
	</body>
</html>
